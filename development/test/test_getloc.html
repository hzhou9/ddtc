<!DOCTYPE html>
<html>
<head>
    <title>获取当前坐标</title>
    <meta charset="utf-8">
    <script src="../golba_rs/js/sys.js"></script>
</head>
<style>
    html,body{
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
    }
</style>
<script src="../golba_rs/js/jquery-1.9.1.min.js"></script>
<script src="../golba_rs/js/iscroll.js"></script>

<body>
<ul style="list-style: none">
    <li><label>城市:</label>
        <select id="city">
            <option value ="021">上海</option>
        </select>
    </li>
    <li><label>地址:</label><input id="address1" placeholder="输入地址"></li>
    <li><label>经度(lat)</label><input id="p_lat" readonly></li>
    <li><label>纬度(lng)</label><input id="p_lng" readonly></li>
    <li><button id='bttest'>获取坐标</button></li>
</ul>
<div id="alertinfo" style="position: absolute; width: 100%; z-index: 10001; left: 0px; bottom: 0px; display: block;text-align:center;">
</div>
</body>
<script>
    (function($){
        $.fn.Maplocation = (function(){
            var mapcontaion = $('<div></div>');
            var mapmake = $('<div></div>');
            var mapdom = $('<div></div>');
            var mapoppanel = $('<div>' +
                    '<div name="info" style="clear: both;padding: 10px;border-bottom: solid 1px #ccc;position: absolute;left: 0;bottom: 100%;z-index: 10000;background-color: rgba(0,0,0,.8);width: 100%;color: #fff">' +
                    '<table style="width: 100%"><tr>' +
                    '<td>经度:<span name="lat"></span></td>' +
                    '<td>纬度:<span name="lng"></span></td>' +
                    '</tr>' +
                    '<tr>' +
                    '<td><div name="btclose" style="text-align: center;border: solid 1px #ccc;margin: 5%;">退出</div></td>' +
                    '<td><div name="btselect" style="text-align: center;border: solid 1px #ccc;margin: 5%;">选择</div></td>' +
                    '</tr>' +
                    '</table>' +
                    '</div>' +
                    '<div name="list" style="width: 100%;height: 100%;overflow: hidden;position: absolute;left: 0;top: 0;background-color: #fff"><ul style="list-style: none;margin: 0;padding: 0"></ul></div>' +
                    '</div>');
            var mapid = '__________mapid';

            mapdom.attr('id',mapid);
            mapcontaion.append(mapmake).append(mapdom).append(mapoppanel);
            mapcontaion.css({
                position:'absolute'
                ,display:'none'
                ,width:'100%'
                ,height:'100%'
                ,'zIndex':'10000'
                ,left:0
                ,top:0
                ,backgroundColor:'rgba(0,0,0,.5)'
            });
            mapmake.css({
                position:'absolute'
                ,width:'100%'
                ,height:'100%'
            }).click(function(){
                mapcontaion.hide();
            });
            mapdom.css({
               position:'absolute'
                ,width:'100%'
                ,height:'60%'
                ,left:0
                ,top:0

            });
            mapoppanel.css({
                position:'absolute'
                ,width:'100%'
                ,height:'40%'
                ,left:0
                ,top:'60%'
                ,backgroundColor:'#fff'
            }).find('[name=btclose]').click(function(){
               obj.close();
            }).end().find('[name=btselect]').click(function(){
               obj.select();
            });
            $(document.body).append(mapcontaion);

            var mapcontaionui = {
                iscroll:null
                ,show:function(){
                    mapcontaion.show();
                }
                ,hide:function(){
                    mapcontaion.hide();
                }
                ,list:function(datas, cb){
                    var list = mapcontaion.find('[name=list]');
                    var innerlist = list.find('>ul');
                    innerlist.empty();

                    for(var i = 0;i<datas.length;i++){
                        var data = datas[i];
                        var row = $('<li style="padding-top: 10px;padding-bottom: 10px"></li>');
                        (function(row,data){
                            row.html(data.formattedAddress);
                            row.click(function(){
                                console.log(data);
                                cb && cb(data);
                            })
                        })(row,data);
                        innerlist.append(row);
                    }
                    if(datas.length>0){
                        list.show();
                    }else{
                        list.hide();
                    }
                    if(!this.iscroll){
                        this.iscroll = new iScroll(innerlist[0], {desktopCompatibility:true});
                    }else{
                        this.iscroll.refresh();
                    }
                }
                ,setInfo:function(position){
                    var lat = mapcontaion.find('[name=lat]');
                    var lng = mapcontaion.find('[name=lng]');
                    lat.html(position.lat);
                    lng.html(position.lng);
                }
            }
            var loadmapscript = (function(){
               var callback = null;
                var isloading = false;
               var initname = 'loadmapscriptinit_'+(new Date()-0);
               window[initname] = function(){
                   isloading = true;
                    //alert('initname'+'\n'+'loadmap');
                   callback && callback();
               }


               var obj = {
                   load:function(_callback){
                       if(isloading){
                           callback && callback();
                       }else{
                           callback = _callback;
                           var script = document.createElement("script");
                           script.type = "text/javascript";
                           script.src = "http://webapi.amap.com/maps?v=1.3&key=bc59f27d65900532cc4f3c1048dd6122&callback="+initname;
                           document.body.appendChild(script);
                       }
                   }
               };
               return obj;
            })();

            var obj = {
                mapobj:null
                ,onclose:null
                ,init:function(callback, address){
                    var me = this;

                    loadmapscript.load(function(){
                        me.loadPosition(address(), function(geocoderresult){
                            me.initMap(callback, geocoderresult);
                        });
                    });
                }
                ,initMap:function(callback,geocoderresult){
                    mapcontaion.show();
                    this.onclose = callback || null;
                    //var position=new AMap.LngLat(116.397428,39.90923);
                    var centermaker = null;
                    var mapObj = this.mapobj = new AMap.Map(mapid,{
                      view: new AMap.View2D({//创建地图二维视口
                          //center:position,//创建中心点坐标
                        zoom:17, //设置地图缩放级别      //1 -  17
                       rotation:0 //设置地图旋转角度
                     }),
                     lang:"zh_cn"//设置地图语言类型，默认：中文简体
                    });//创建地图实例
                    mapObj.plugin(["AMap.ToolBar","AMap.OverView","AMap.Scale"],function(){
                      //加载工具条
                      var tool = new AMap.ToolBar({
                        direction:false,//隐藏方向导航
                        ruler:false,//隐藏视野级别控制尺
                         offset:new AMap.Pixel(10,200)
                        //autoPosition:true//自动定位
                      });
                      mapObj.addControl(tool);
                      //加载鹰眼
                      var view = new AMap.OverView();
                      mapObj.addControl(view);
                      //加载比例尺
                      //var scale = new AMap.Scale();mapObj.addControl(scale);
                    });

                    var resulttxt = "条搜索结果";
                    if(geocoderresult){
                            resulttxt=''+geocoderresult.geocodes.length+resulttxt;
                        mapcontaionui.list(geocoderresult.geocodes, function(data){
                            mapObj.setCenter(data.location);
                            setTimeout(function(){
                                setposition();
                            },500);
                        });
                    }else{
                            resulttxt='0'+resulttxt;
                    }
                    $('#alertinfo').html('初始化地图（'+resulttxt+'）...');
                    var callbacking = false;
                    AMap.event.addListener(mapObj,'complete',function(){
                      $('#alertinfo').html('开始获取当前坐标（'+resulttxt+'）...');
                      mapObj.plugin('AMap.Geolocation', function () {
                        var geolocation = new AMap.Geolocation({
                            enableHighAccuracy: true,//是否使用高精度定位，默认:true
                            timeout: 5000,          //超过10秒后停止定位，默认：无穷大
                            maximumAge: 0,           //定位结果缓存0毫秒，默认：0
                            convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                            showButton: false,        //显示定位按钮，默认：true
                            buttonPosition: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
                            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                            showMarker: false,        //定位成功后在定位到的位置显示点标记，默认：true
                            showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
                            panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
                            zoomToAccuracy:false      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                        });
                        mapObj.addControl(geolocation);
                        AMap.event.addListener(geolocation, 'complete', function(arg){
                            if(!callbacking){
                                callbacking = true;
                                mapObj.setCenter(arg.position);
                                setTimeout(function(){setposition();},500);
                                $('#alertinfo').html('已经定位当前坐标（'+resulttxt+'）');
                            }
                        });//返回定位信息
                        AMap.event.addListener(geolocation, 'error', function(){
                            alert('当前环境不支持获取定位,请在设置中允许使用[位置定位服务]');
                        });//返回定位出错信息
                        geolocation.getCurrentPosition();
                      });
                    
                         centermaker = new AMap.Marker({
                            map:mapObj
                            ,content:"<div style='width: 50px;height: 50px;border-radius: 25px;background-color: rgba(0,0,0,.2)'><div style='position: absolute;left: 50%;top:50%;width: 6px;height: 6px;border-radius: 3px;margin-left: -3px;margin-top: -3px;background-color:red'></div></div>"
                            ,position:mapObj.getCenter()
                             ,offset:new AMap.Pixel(-25,-25)
                        });
                    });


                    AMap.event.addListener(mapObj,'moveend',function(){
                        setposition();
                    });
                    AMap.event.addListener(mapObj,'mapmove',function(){
                        setposition();
                    });
                    function setposition(){
                        centermaker.setPosition(mapObj.getCenter());
                        mapcontaionui.setInfo(mapObj.getCenter());
                    }
                    /**
                    navigator.geolocation.getCurrentPosition(function(a){
                        console.log(a)
                        //alert('当前支持获取位置');
                    }, function(e){
                        console.log('error',e);
                        alert('当前不支持获取地理位置');
                    })
                     */
                }
                ,loadPosition:function(address, cb){
                    if(address && address.addr != ''){
                        var MGeocoder;
                        //加载地理编码插件
                        AMap.service(["AMap.Geocoder"], function() {
                            MGeocoder = new AMap.Geocoder({
                                city:address.city, //城市，默认：“全国”
                                radius:1000 //范围，默认：500
                            });
                            //返回地理编码结果
                            //地理编码
                            MGeocoder.getLocation(address.addr, function(status, result){
                                if(status === 'complete' && result.info === 'OK'){
                                    cb && cb(result);
                                }else{
                                    cb && cb(null);
                                }
                            });
                        });
                    }else{
                        cb && cb(null);
                    }
                }
                ,close:function(){
                    this.mapobj.destroy();
                    this.mapobj = null;
                    this.onclose = null;
                    mapcontaion.hide();
                }
                ,select:function(){
                    this.onclose && this.onclose(this.mapobj.getCenter());
                    this.close();
                }
            }
            return function(callback, address){
                $(this).click(function(){
                    $('#alertinfo').html('开始加载地图模块...');
                    obj.init(callback, address);
                });
            }
        })();
    })(jQuery);
</script>
<script>
    $('#bttest').Maplocation(function(position){
        console.log(position);
        $('#p_lng').val(position.lng);
        $('#p_lat').val(position.lat);
    },function(){return {'city':$('#city').val(),'addr':$('#address1').val()};});
</script>
</html>